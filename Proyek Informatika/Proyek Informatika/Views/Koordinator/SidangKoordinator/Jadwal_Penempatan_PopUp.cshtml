<script>
    var arr = new Array();

    $("#buttonSimpan").click(function () {
        //validasi trus simpan jadwal
        var radio = document.getElementsByName("modeJadwal");
        if ($("#radio_1").is(":checked")) {
            var values = {
                npm: $("#npm-label").html(),
                tanggal: $("#waktuManual").val(),
                ruang: $("#ruangManual").val(),
                penguji1: $("#penguji1Manual").val(),
                penguji2: $("#penguji2Manual").val()
            };
            $.post("SidangKoordinator/SimpanJadwal", values, function (data) {
                if (data == "True") {
                    alert("Data berhasil diubah.");
                } else {
                    alert("Data tidak berhasil diubah.");
                }
            });
        } else {
            var waktu = $("#selWaktu").val().toString().substring(0, $("#selWaktu").val().toString().length - 3);
            var values = {
                npm: $("#npm-label").html(),
                tanggal: $("#selTanggal").val() + " " + waktu,
                ruang: $("#selRuang").val(),
                penguji1: $("#selPenguji").val(),
                penguji2: $("#selPenguji2").val()
            };
            $.post("SidangKoordinator/SimpanJadwal", values, function (data) {
                if (data == "True") {
                    alert("Data berhasil diubah.");
                } else {
                    alert("Data tidak berhasil diubah.");
                }
            });
        }
    });
    function init() {
        $("#radio_1").prop('checked', true);
        changeMode(1);
        $.post("Query/GetDosenList", "", function (data) {
            var get = "";
            $.each(data, function (index, value) {
                if (value.nama != $("#pembimbing-label").html()) {
                    get += "<option value='" + value.NIK + "'>" + value.nama + "</option>";
                }

            });
            $("#selPenguji").html(get);
            $("#penguji1Manual").html(get);
        });

        $.post("Query/GetDosenList", "", function (data) {
            var get = "<option>--</option>";
            $.each(data, function (index, value) {
                if (value.nama != $("#pembimbing-label").html()) {
                    get += "<option value='" + value.NIK + "'>" + value.nama + "</option>";
                }

            });
            
            $("#penguji2Manual").html(get);
        });

        $.post("SidangKoordinator/GetRuangSidang", "", function (data) {
            var get = "";
            $.each(data, function (index, value) {
                get += "<option value='" + value.id + "'>" + value.nama_ruang + "</option>";
            });
            $("#ruangManual").html(get);
        });

        $.post("SidangKoordinator/GetPopUpDetails", { npm: $("#npm-label").html() }, function (data) {
            if (data.success) {
                $("#penguji1Manual").val(data.penguji1);
                $("#penguji2Manual").val(data.penguji2);
                $("#waktuManual").val(data.tanggal);
                $("#ruangManual").val(data.ruang);
                $("#selPenguji").val(data.penguji1);
                var a = data.tanggal.split(" ");

                $.when(selPengujiChange()).done(function () {
                    $("#selTanggal").val(a[0]);
                    selTanggalChange();
                    $("#selWaktu").val(a[1]);
                    $.when(selWaktuChange()).done(function () {
                        $("#selRuang").val(data.ruang);
                        $.when(selRuangChange()).done(function () {
                            var penguji2 = data.penguji2 == null ? "--" : data.penguji2;
                            $("#selPenguji2").val(penguji2);
                        });
                    });
                });
            } else {
                var date = new Date();
                $("#waktuManual").val((date.getDay() + 1) + "/" + (date.getMonth() + 1) + "/" + date.getFullYear() + " 00:00");
                //ruang: $("#ruangManual").val(),

            }
        });
    }
    function selPengujiChange() {
        $("#selTanggal").html("");
        $("#selWaktu").html("");
        $("#selRuang").html("");
        $("#selPenguji2").html("");
        var values = {
            npm: $("#npm-label").html(),
            pembimbing: $("#pembimbing-label").html(),
            penguji: $("#selPenguji").val()
        };
        return $.post("SidangKoordinator/GetTanggalSidangList", values, function (data) {
            var get = "";
            var i = 0;
            var temp = "";
            $.each(data, function (index, value) {
                var a = value.split(" ");
                arr[i] = a;
                i++;
                if (temp != a[0]) {
                    temp = a[0];
                    get += "<option value='" + a[0] + "'>" + a[0] + "</option>";
                }

            });
            $("#selTanggal").html(get);

        });
    }

    function selTanggalChange() {
        $("#selWaktu").html("");
        $("#selRuang").html("");
        $("#selPenguji2").html("");
        var get = "";
        for (var i = 0; i < arr.length; i++) {
            var a = arr[i].toString().split(",");
            if (a[0] == $("#selTanggal").val()) {
                get += "<option value='" + a[1] + "'>" + a[1] + "</option>";
            }
        }
        $("#selWaktu").html(get);
    }

    function selWaktuChange() {
        $("#selRuang").html("");
        $("#selPenguji2").html("");
        var waktu = $(selTanggal).val() + " " + $("#selWaktu").val();
        var values = {
            waktu: waktu
        };
        return $.post("SidangKoordinator/GetRuangKosong", values, function (data) {
            var get = "";
            $.each(data, function (index, value) {
                get += "<option value='" + value.id + "'>" + value.nama_ruang + "</option>";
            });
            $("#selRuang").html(get);
        });
    }

    function selRuangChange() {
        $("#selPenguji2").html("");
        
        var waktu = $(selTanggal).val() + " " + $("#selWaktu").val();
        return $.post("SidangKoordinator/GetPenguji2", { npm: $("#npm-label").html(), waktu: waktu }, function (data) {

            var get = "<option value='--'>--</option>";
            $.each(data, function (index, value) {
                get += "<option value='" + value.NIK + "'>" + value.nama + "</option>";
            });
            $("#selPenguji2").html(get);
        });
    }

    $(document).ready(function () {

        $("#selPenguji").bind("change", function () {
            selPengujiChange();
        });

        $("#selTanggal").bind("change", function () {
            selTanggalChange();
        });

        $("#selWaktu").bind("change", function () {
            selWaktuChange();
        });

        $("#selRuang").bind("change", function () {
            selRuangChange();
        });

    });

    function changeMode(num) {
        if(num==1){
            $("#mode1").show();
            $("#mode2").hide();
        }else if(num==2){
            $("#mode2").show();
            $("#mode1").hide();
        }
    }
</script>

<div id="popup" style="width:700px;">
    <table>
        <tr>
            <td>NPM:</td>
            <td><span id="npm-label"></span></td>
        </tr>
        <tr>
            <td>Nama:</td>
            <td><span id="nama-label"></span></td>
        </tr>
        <tr>
            <td>Topik:</td>
            <td><span id="topik-label"></span></td>
        </tr>
        <tr>
            <td>Pembimbing:</td>
            <td><span id="pembimbing-label"></span></td>
        </tr>
        <tr>
            <td>Mode :</td>
            <td>
                <input type="radio" name="modeJadwal" onclick="changeMode(1)" id="radio_1" checked="checked" />Manual
                <input type="radio" name="modeJadwal" onclick="changeMode(2)" id="radio_2" />Semi-Automatic
            </td>
        </tr>
    </table>
    <div id="mode1">
        <table>
            <tr>
                <td>Penguji 1:</td>
                <td><select id="penguji1Manual"></select></td>
            </tr>
            <tr>
                <td>Penguji 2:</td>
                <td><select id="penguji2Manual"></select></td>
            </tr>
            <tr>
                <td>Waktu:</td>
                <td>@(Html.Telerik().DateTimePicker().Name("waktuManual").Value(DateTime.Now))</td>
            </tr>
            <tr>
                <td>Ruang:</td>
                <td><select id="ruangManual"></select></td>
            </tr>
        </table>
        <span >*peringatan : mode ini tidak melakukan validasi jadwal</span><br />
        
    </div>
    <div style="overflow:hidden;display:none;" id="mode2">
        <div style="float:left;">
            <span>Penguji 1</span><br />
            <select size="10" id="selPenguji" style="width:100px"></select>
        </div>
        <div style="float:left;">
            <span>Tanggal</span><br />
            <select size="10" id="selTanggal" style="width:300px"></select>
        </div>
        <div style="float:left;">
            <span>Waktu</span><br />
            <select size="10" id="selWaktu" style="width:100px"></select>
        </div>
        <div style="float:left;">
            <span>Ruang</span><br />
            <select size="10" id="selRuang" style="width:100px"></select>
        </div>

        <div style="float:left;">
            <span>Penguji 2</span><br />
            <select size="10" id="selPenguji2" style="width:100px"></select>
        </div>
    </div><br />
    <input type="button" value="Simpan" id="buttonSimpan" class="t-button t-state-default" />
</div>